<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Modeling in the Tidyverse</title>
    <meta charset="utf-8" />
    <meta name="author" content="Giora Simchoni" />
    <meta name="date" content="2023-02-24" />
    <script src="u1_d05-modeling_files/header-attrs-2.20/header-attrs.js"></script>
    <head>
      <link rel="icon" href="../DSApps_logo.jpg" type="image/jpg"> 
      <link rel="shortcut icon" href="../DSApps_logo.jpg" type="image/jpg">
    </head>
    <link rel="stylesheet" href="../slides.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">


class: logo-slide

---

class: title-slide

## Modeling in the Tidyverse

### Applications of Data Science - Class 5

### Giora Simchoni

#### `gsimchoni@gmail.com and add #dsapps in subject`

### Stat. and OR Department, TAU
### 2023-02-24

---



layout: true

&lt;div class="my-footer"&gt;
  &lt;span&gt;
    &lt;a href="https://dsapps-2023.github.io/Class_Slides/" target="_blank"&gt;Applications of Data Science
    &lt;/a&gt;
  &lt;/span&gt;
&lt;/div&gt;

---



class: section-slide

# The Problem

---

### Inconsistency, Inextensibility


```r
n &lt;- 10000
x1 &lt;- runif(n)
x2 &lt;- runif(n)
t &lt;- 1 + 2 * x1 + 3 * x2
y &lt;- rbinom(n, 1, 1 / (1 + exp(-t)))
```


```r
glm(y ~ x1 + x2, family = "binomial")
```


```r
glmnet(as.matrix(cbind(x1, x2)), as.factor(y), family = "binomial")
```


```r
randomForest(as.factor(y) ~ x1 + x2)
```



```r
gbm(y ~ x1 + x2, data = data.frame(x1 = x1, x2 = x2, y = y))
```

😱

---

### Compare this with `sklearn`


```python
from sklearn.linear_model import LogisticRegression
from sklearn.ensemble import RandomForestClassifier,
  GradientBoostingClassifier

LogisticRegression(penalty='none').fit(X, y)

LogisticRegression(penalty='l2', C=0.001).fit(X, y)

RandomForestClassifier(n_estimators=100).fit(X, y)

GradientBoostingClassifier(n_estimators=100).fit(X, y)
```

---

class: section-slide

# Detour: A Regression Problem

---

### Hungarian Blogs: Predicting Feedback

- Dataset was published as part of the [UCI ML Repository](https://archive.ics.uci.edu/ml/datasets/BlogFeedback) initiative
- Comes from [Buza 2014](http://www.cs.bme.hu/~buza/pdfs/gfkl2012_blogs.pdf)
- 280 numeric heavily engineered features on blogs and posts published in the last 72 hours
- Can we predict no. of comments in the next 24 hours?

&lt;img src="images/hungarian_blog.png" style="width: 70%" /&gt;

---

The raw data has over 50K rows: for each blog features like total comments until base time, weekday, words, etc.

We will be predicting `log(fb)` based on all features, no missing values:


```r
blogs_fb &lt;- read_csv("~/BlogFeedback/blogData_train.csv", col_names = FALSE)

blogs_fb &lt;- blogs_fb %&gt;%
  rename(fb = X281, blog_len = X62, sunday = X276) %&gt;%
  mutate(fb = log(fb + 1))

dim(blogs_fb)
```

```
## [1] 52397   281
```

---


```r
glimpse(blogs_fb)
```

```
## Rows: 52,397
## Columns: 281
## $ X1       &lt;dbl&gt; 40.30467, 40.30467, 40.30467, 40.30467, 40.30467, 40.30467, 4…
## $ X2       &lt;dbl&gt; 53.84566, 53.84566, 53.84566, 53.84566, 53.84566, 53.84566, 5…
## $ X3       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X4       &lt;dbl&gt; 401, 401, 401, 401, 401, 401, 401, 401, 401, 401, 401, 401, 4…
## $ X5       &lt;dbl&gt; 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 15, 1…
## $ X6       &lt;dbl&gt; 15.52416, 15.52416, 15.52416, 15.52416, 15.52416, 15.52416, 1…
## $ X7       &lt;dbl&gt; 32.44188, 32.44188, 32.44188, 32.44188, 32.44188, 32.44188, 3…
## $ X8       &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X9       &lt;dbl&gt; 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 3…
## $ X10      &lt;dbl&gt; 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3, 3…
## $ X11      &lt;dbl&gt; 14.04423, 14.04423, 14.04423, 14.04423, 14.04423, 14.04423, 1…
## $ X12      &lt;dbl&gt; 32.61542, 32.61542, 32.61542, 32.61542, 32.61542, 32.61542, 3…
## $ X13      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X14      &lt;dbl&gt; 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 3…
## $ X15      &lt;dbl&gt; 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2, 2…
## $ X16      &lt;dbl&gt; 34.56757, 34.56757, 34.56757, 34.56757, 34.56757, 34.56757, 3…
## $ X17      &lt;dbl&gt; 48.47518, 48.47518, 48.47518, 48.47518, 48.47518, 48.47518, 4…
## $ X18      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X19      &lt;dbl&gt; 378, 378, 378, 378, 378, 378, 378, 378, 378, 378, 378, 378, 3…
## $ X20      &lt;dbl&gt; 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 12, 1…
## $ X21      &lt;dbl&gt; 1.479934, 1.479934, 1.479934, 1.479934, 1.479934, 1.479934, 1…
## $ X22      &lt;dbl&gt; 46.18691, 46.18691, 46.18691, 46.18691, 46.18691, 46.18691, 4…
## $ X23      &lt;dbl&gt; -356, -356, -356, -356, -356, -356, -356, -356, -356, -356, -…
## $ X24      &lt;dbl&gt; 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 377, 3…
## $ X25      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X26      &lt;dbl&gt; 1.076167, 1.076167, 1.076167, 1.076167, 1.076167, 1.076167, 1…
## $ X27      &lt;dbl&gt; 1.795416, 1.795416, 1.795416, 1.795416, 1.795416, 1.795416, 1…
## $ X28      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X29      &lt;dbl&gt; 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 11, 1…
## $ X30      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X31      &lt;dbl&gt; 0.4004914, 0.4004914, 0.4004914, 0.4004914, 0.4004914, 0.4004…
## $ X32      &lt;dbl&gt; 1.078097, 1.078097, 1.078097, 1.078097, 1.078097, 1.078097, 1…
## $ X33      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X34      &lt;dbl&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…
## $ X35      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X36      &lt;dbl&gt; 0.3775594, 0.3775594, 0.3775594, 0.3775594, 0.3775594, 0.3775…
## $ X37      &lt;dbl&gt; 1.07421, 1.07421, 1.07421, 1.07421, 1.07421, 1.07421, 1.07421…
## $ X38      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X39      &lt;dbl&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…
## $ X40      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X41      &lt;dbl&gt; 0.972973, 0.972973, 0.972973, 0.972973, 0.972973, 0.972973, 0…
## $ X42      &lt;dbl&gt; 1.704671, 1.704671, 1.704671, 1.704671, 1.704671, 1.704671, 1…
## $ X43      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X44      &lt;dbl&gt; 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 1…
## $ X45      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X46      &lt;dbl&gt; 0.02293202, 0.02293202, 0.02293202, 0.02293202, 0.02293202, 0…
## $ X47      &lt;dbl&gt; 1.521174, 1.521174, 1.521174, 1.521174, 1.521174, 1.521174, 1…
## $ X48      &lt;dbl&gt; -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -8, -…
## $ X49      &lt;dbl&gt; 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9, 9…
## $ X50      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X51      &lt;dbl&gt; 2, 6, 6, 2, 3, 6, 6, 3, 30, 30, 0, 0, 30, 0, 51, 10, 32, 10, …
## $ X52      &lt;dbl&gt; 2, 2, 2, 2, 1, 0, 0, 1, 27, 27, 0, 0, 30, 0, 51, 10, 2, 10, 5…
## $ X53      &lt;dbl&gt; 0, 4, 4, 0, 2, 2, 2, 2, 1, 1, 0, 0, 0, 0, 0, 0, 30, 0, 0, 51,…
## $ X54      &lt;dbl&gt; 2, 5, 5, 2, 2, 5, 5, 2, 2, 2, 0, 0, 30, 0, 51, 10, 32, 10, 51…
## $ X55      &lt;dbl&gt; 2, -2, -2, 2, -1, -2, -2, -1, 26, 26, 0, 0, 30, 0, 51, 10, -2…
## $ X56      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 1, 2, 3, 0, 2, 0, 3, 4, 0…
## $ X57      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 1, 0, 3, 0, 1, 0, 3, 1, 0…
## $ X58      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 0, 0, 0, 0, 1, 0, 0, 3, 0…
## $ X59      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, 2, 1, 2, 3, 0, 2, 0, 3, 4, 0…
## $ X60      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 2, -2, 1, 0, 3, 0, 0, 0, 3, -2,…
## $ X61      &lt;dbl&gt; 10, 35, 35, 10, 34, 59, 59, 34, 58, 58, 11, 35, 5, 59, 8, 14,…
## $ blog_len &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X63      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X64      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X65      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X66      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X67      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X68      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X69      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X70      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X71      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X72      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X73      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X74      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X75      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X76      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X77      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X78      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X79      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X80      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X81      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X82      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X83      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X84      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X85      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X86      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X87      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X88      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X89      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X90      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X91      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X92      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X93      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X94      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X95      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X96      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X97      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X98      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X99      &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X100     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X101     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X102     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X103     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X104     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X105     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X106     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X107     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X108     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X109     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X110     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X111     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X112     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X113     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X114     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X115     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X116     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X117     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X118     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X119     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X120     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X121     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X122     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X123     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X124     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X125     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X126     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X127     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X128     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X129     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X130     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X131     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X132     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X133     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X134     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X135     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X136     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X137     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X138     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X139     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X140     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X141     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X142     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X143     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X144     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X145     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X146     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X147     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X148     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X149     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X150     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X151     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X152     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X153     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X154     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X155     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X156     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X157     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X158     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X159     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X160     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X161     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X162     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X163     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X164     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X165     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X166     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X167     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X168     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X169     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X170     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X171     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X172     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X173     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X174     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X175     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X176     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X177     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X178     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X179     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X180     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X181     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X182     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X183     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X184     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X185     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X186     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X187     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X188     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X189     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X190     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X191     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X192     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X193     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X194     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X195     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X196     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X197     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X198     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X199     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X200     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X201     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X202     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X203     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X204     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X205     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X206     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X207     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X208     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X209     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X210     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X211     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X212     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X213     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X214     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X215     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X216     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X217     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X218     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X219     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X220     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X221     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X222     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X223     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X224     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X225     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X226     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X227     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X228     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X229     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X230     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X231     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X232     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X233     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X234     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X235     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X236     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X237     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X238     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X239     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X240     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X241     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X242     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X243     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X244     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X245     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X246     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X247     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X248     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X249     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X250     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X251     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X252     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X253     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X254     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X255     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X256     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X257     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X258     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X259     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X260     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X261     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X262     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X263     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X264     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0…
## $ X265     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 1, 1, 0, 0…
## $ X266     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1…
## $ X267     &lt;dbl&gt; 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X268     &lt;dbl&gt; 0, 0, 0, 0, 1, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X269     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X270     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 0, 0, 0, 1, 0, 0, 0, 0…
## $ X271     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 1, 1, 1…
## $ X272     &lt;dbl&gt; 0, 1, 1, 0, 0, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X273     &lt;dbl&gt; 1, 0, 0, 1, 1, 0, 0, 1, 1, 1, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X274     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X275     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 1, 1, 0, 1, 0, 0, 0, 0, 0, 0, 0…
## $ sunday   &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X277     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X278     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X279     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ X280     &lt;dbl&gt; 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0…
## $ fb       &lt;dbl&gt; 0.6931472, 0.0000000, 0.0000000, 0.6931472, 3.3322045, 0.0000…
```

---

See the dependent variable distribution:


```r
ggplot(blogs_fb, aes(fb)) +
  geom_histogram(fill = "red", alpha = 0.5, binwidth = 0.5) +
  theme_bw()
```

&lt;img src="images/Bench-Hist-1.png" width="100%" /&gt;

---

See it vs. say "length of post":


```r
ggplot(blogs_fb, aes(log(blog_len), fb)) +
  geom_point(color = "red", alpha = 0.5) +
  theme_bw()
```

&lt;img src="images/Bench-Age-Equipment-1.png" width="100%" /&gt;

---

class: section-slide

# End of Detour

---

# WARNING

.warning[
💡 What you're about to see is not a good modeling/prediction flow.

This is just an intro to tidy modeling.

Some of the issues with how things are done here will be raised, some will have to wait till later in the course.
]
---

class: section-slide

# The ~~Present~~ Past Solution: `caret`

---

### Split Data


```r
library(caret)

train_idx &lt;- createDataPartition(blogs_fb$fb,
                                 p = 0.6, list = FALSE)

blogs_tr &lt;- blogs_fb[train_idx, ]
blogs_te &lt;- blogs_fb[-train_idx, ]

library(glue)
glue("train no. of rows: {nrow(blogs_tr)}
     test no. of rows: {nrow(blogs_te)}")
```

```
## train no. of rows: 31439
## test no. of rows: 20958
```

Here you might consider some preprocessing.

`caret` has some nice documentation [here](https://topepo.github.io/caret/index.html).

---

### Tuning and Modeling

Define general methodology, e.g. 5-fold Cross-Validation:


```r
fit_control &lt;- trainControl(method = "cv", number = 5)

ridge_grid &lt;- expand.grid(alpha=0, lambda = 10^seq(-3, 1, length = 50))
lasso_grid &lt;- expand.grid(alpha=1, lambda = 10^seq(-3, 1, length = 50))
rf_grid &lt;- expand.grid(splitrule = "variance",
                       min.node.size = seq(10, 30, 10),
                       mtry = seq(10, 50, 20))

mod_ridge &lt;- train(fb ~ ., data = blogs_tr, method = "glmnet",
                trControl = fit_control, tuneGrid = ridge_grid,
                metric = "RMSE")

mod_lasso &lt;- train(fb ~ ., data = blogs_tr, method = "glmnet",
                trControl = fit_control, tuneGrid = lasso_grid,
                metric = "RMSE")

mod_rf &lt;- train(fb ~ ., data = blogs_tr, method = "ranger",
                trControl = fit_control, tuneGrid = rf_grid,
                num.trees = 50, metric = "RMSE")
```

---

### Evaluating Models


```r
mod_ridge
```

```
## glmnet 
## 
## 31439 samples
##   280 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (5 fold) 
## Summary of sample sizes: 25151, 25152, 25151, 25151, 25151 
## Resampling results across tuning parameters:
## 
##   lambda        RMSE       Rsquared   MAE      
##    0.001000000  0.8462670  0.4467763  0.5891955
##    0.001206793  0.8462670  0.4467763  0.5891955
##    0.001456348  0.8462670  0.4467763  0.5891955
##    0.001757511  0.8462670  0.4467763  0.5891955
##    0.002120951  0.8462670  0.4467763  0.5891955
##    0.002559548  0.8462670  0.4467763  0.5891955
##    0.003088844  0.8462670  0.4467763  0.5891955
##    0.003727594  0.8462670  0.4467763  0.5891955
##    0.004498433  0.8462670  0.4467763  0.5891955
##    0.005428675  0.8462670  0.4467763  0.5891955
##    0.006551286  0.8462670  0.4467763  0.5891955
##    0.007906043  0.8462670  0.4467763  0.5891955
##    0.009540955  0.8462670  0.4467763  0.5891955
##    0.011513954  0.8462670  0.4467763  0.5891955
##    0.013894955  0.8462670  0.4467763  0.5891955
##    0.016768329  0.8462670  0.4467763  0.5891955
##    0.020235896  0.8462670  0.4467763  0.5891955
##    0.024420531  0.8462670  0.4467763  0.5891955
##    0.029470517  0.8462670  0.4467763  0.5891955
##    0.035564803  0.8462670  0.4467763  0.5891955
##    0.042919343  0.8462670  0.4467763  0.5891955
##    0.051794747  0.8462670  0.4467763  0.5891955
##    0.062505519  0.8463303  0.4466940  0.5892460
##    0.075431201  0.8476334  0.4450468  0.5902559
##    0.091029818  0.8489805  0.4433555  0.5912747
##    0.109854114  0.8503636  0.4416357  0.5922900
##    0.132571137  0.8517855  0.4398908  0.5933145
##    0.159985872  0.8532586  0.4381133  0.5943616
##    0.193069773  0.8547931  0.4363009  0.5954677
##    0.232995181  0.8564072  0.4344428  0.5966594
##    0.281176870  0.8581392  0.4325027  0.5979996
##    0.339322177  0.8600462  0.4304191  0.5995746
##    0.409491506  0.8621701  0.4281492  0.6014666
##    0.494171336  0.8645713  0.4256302  0.6037552
##    0.596362332  0.8673229  0.4227647  0.6064828
##    0.719685673  0.8704745  0.4194864  0.6097936
##    0.868511374  0.8740811  0.4157225  0.6137014
##    1.048113134  0.8781775  0.4114084  0.6182659
##    1.264855217  0.8827829  0.4064977  0.6234616
##    1.526417967  0.8878920  0.4009780  0.6291817
##    1.842069969  0.8934911  0.3948520  0.6353284
##    2.222996483  0.8995546  0.3881423  0.6418220
##    2.682695795  0.9060288  0.3809196  0.6485822
##    3.237457543  0.9128611  0.3732731  0.6555396
##    3.906939937  0.9199982  0.3653126  0.6626825
##    4.714866363  0.9273925  0.3571633  0.6699344
##    5.689866029  0.9350071  0.3489600  0.6772930
##    6.866488450  0.9428191  0.3408396  0.6847120
##    8.286427729  0.9508189  0.3329273  0.6921962
##   10.000000000  0.9590093  0.3253253  0.6997757
## 
## Tuning parameter 'alpha' was held constant at a value of 0
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were alpha = 0 and lambda = 0.05179475.
```

---


```r
mod_lasso
```

```
## glmnet 
## 
## 31439 samples
##   280 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (5 fold) 
## Summary of sample sizes: 25152, 25150, 25151, 25152, 25151 
## Resampling results across tuning parameters:
## 
##   lambda        RMSE       Rsquared   MAE      
##    0.001000000  0.8333364  0.4630729  0.5774531
##    0.001206793  0.8338379  0.4624286  0.5778514
##    0.001456348  0.8344579  0.4616355  0.5784054
##    0.001757511  0.8354024  0.4604269  0.5792853
##    0.002120951  0.8367088  0.4587510  0.5804684
##    0.002559548  0.8379595  0.4571494  0.5815771
##    0.003088844  0.8395353  0.4551339  0.5828745
##    0.003727594  0.8416496  0.4524126  0.5845320
##    0.004498433  0.8434856  0.4500571  0.5857410
##    0.005428675  0.8458443  0.4470098  0.5873684
##    0.006551286  0.8481986  0.4439628  0.5890618
##    0.007906043  0.8502710  0.4412905  0.5905821
##    0.009540955  0.8530251  0.4376999  0.5925616
##    0.011513954  0.8553405  0.4346936  0.5942513
##    0.013894955  0.8575749  0.4318132  0.5959307
##    0.016768329  0.8588602  0.4302636  0.5971247
##    0.020235896  0.8598492  0.4291907  0.5981324
##    0.024420531  0.8608683  0.4281924  0.5992518
##    0.029470517  0.8621277  0.4270104  0.6005513
##    0.035564803  0.8638481  0.4253617  0.6023754
##    0.042919343  0.8658574  0.4235649  0.6047810
##    0.051794747  0.8683445  0.4214623  0.6079707
##    0.062505519  0.8712928  0.4192295  0.6121897
##    0.075431201  0.8748340  0.4169270  0.6176785
##    0.091029818  0.8790920  0.4147007  0.6242958
##    0.109854114  0.8839360  0.4133758  0.6321321
##    0.132571137  0.8908160  0.4113907  0.6419080
##    0.159985872  0.9007450  0.4079262  0.6541466
##    0.193069773  0.9150199  0.4015380  0.6695049
##    0.232995181  0.9354243  0.3890117  0.6888980
##    0.281176870  0.9632650  0.3655393  0.7126533
##    0.339322177  0.9904815  0.3560733  0.7336473
##    0.409491506  1.0260527  0.3443092  0.7584069
##    0.494171336  1.0730671  0.3068237  0.7885088
##    0.596362332  1.1249915  0.2968225  0.8176237
##    0.719685673  1.1371361        NaN  0.8242276
##    0.868511374  1.1371361        NaN  0.8242276
##    1.048113134  1.1371361        NaN  0.8242276
##    1.264855217  1.1371361        NaN  0.8242276
##    1.526417967  1.1371361        NaN  0.8242276
##    1.842069969  1.1371361        NaN  0.8242276
##    2.222996483  1.1371361        NaN  0.8242276
##    2.682695795  1.1371361        NaN  0.8242276
##    3.237457543  1.1371361        NaN  0.8242276
##    3.906939937  1.1371361        NaN  0.8242276
##    4.714866363  1.1371361        NaN  0.8242276
##    5.689866029  1.1371361        NaN  0.8242276
##    6.866488450  1.1371361        NaN  0.8242276
##    8.286427729  1.1371361        NaN  0.8242276
##   10.000000000  1.1371361        NaN  0.8242276
## 
## Tuning parameter 'alpha' was held constant at a value of 1
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were alpha = 1 and lambda = 0.001.
```

---


```r
mod_rf
```

```
## Random Forest 
## 
## 31439 samples
##   280 predictor
## 
## No pre-processing
## Resampling: Cross-Validated (5 fold) 
## Summary of sample sizes: 25151, 25152, 25152, 25151, 25150 
## Resampling results across tuning parameters:
## 
##   min.node.size  mtry  RMSE       Rsquared   MAE      
##   10             10    0.6982353  0.6300362  0.4477895
##   10             30    0.6565384  0.6679521  0.4090834
##   10             50    0.6493738  0.6744561  0.4023975
##   20             10    0.7057277  0.6227657  0.4538613
##   20             30    0.6616067  0.6633432  0.4160850
##   20             50    0.6511654  0.6730767  0.4062798
##   30             10    0.7110096  0.6177993  0.4593662
##   30             30    0.6652902  0.6597730  0.4189310
##   30             50    0.6539612  0.6703397  0.4090870
## 
## Tuning parameter 'splitrule' was held constant at a value of variance
## RMSE was used to select the optimal model using the smallest value.
## The final values used for the model were mtry = 50, splitrule = variance
##  and min.node.size = 10.
```

---


```r
plot(mod_ridge)
```

&lt;img src="images/Ridge-CV-1.png" width="80%" /&gt;

---


```r
plot(mod_lasso)
```

&lt;img src="images/Lasso-CV-1.png" width="80%" /&gt;

---


```r
plot(mod_rf)
```

&lt;img src="images/RF-CV-1.png" width="80%" /&gt;

---

### Comparing Models


```r
resamps &lt;- resamples(list(Ridge = mod_ridge, Lasso = mod_lasso,
                          RF = mod_rf))
summary(resamps)
```

```
## 
## Call:
## summary.resamples(object = resamps)
## 
## Models: Ridge, Lasso, RF 
## Number of resamples: 5 
## 
## MAE 
##            Min.   1st Qu.    Median      Mean   3rd Qu.      Max. NA's
## Ridge 0.5836974 0.5897172 0.5901640 0.5891955 0.5910708 0.5913280    0
## Lasso 0.5721159 0.5744051 0.5752703 0.5774531 0.5815676 0.5839066    0
## RF    0.3935699 0.4009682 0.4022208 0.4023975 0.4034971 0.4117315    0
## 
## RMSE 
##            Min.   1st Qu.    Median      Mean   3rd Qu.      Max. NA's
## Ridge 0.8325399 0.8412139 0.8439569 0.8462670 0.8534569 0.8601674    0
## Lasso 0.8184963 0.8311307 0.8320203 0.8333364 0.8413560 0.8436785    0
## RF    0.6399914 0.6433239 0.6449060 0.6493738 0.6538199 0.6648279    0
## 
## Rsquared 
##            Min.   1st Qu.    Median      Mean   3rd Qu.      Max. NA's
## Ridge 0.4416434 0.4419044 0.4423275 0.4467763 0.4513238 0.4566826    0
## Lasso 0.4545655 0.4568166 0.4620469 0.4630729 0.4656187 0.4763170    0
## RF    0.6508170 0.6726716 0.6758509 0.6744561 0.6821786 0.6907624    0
```

---


```r
dotplot(resamps, metric = "RMSE")
```

&lt;img src="images/Caret-RMSE-Comp-1.png" width="100%" /&gt;

---

### Predicting


```r
pred_ridge &lt;- predict(mod_ridge, newdata = blogs_te)
pred_lasso &lt;- predict(mod_lasso, newdata = blogs_te)
pred_rf &lt;- predict(mod_rf, newdata = blogs_te)

rmse_ridge &lt;- RMSE(pred_ridge, blogs_te$fb)
rmse_lasso &lt;- RMSE(pred_lasso, blogs_te$fb)
rmse_rf &lt;- RMSE(pred_rf, blogs_te$fb)

glue("Test RMSE Ridge: {format(rmse_ridge, digits = 3)}
     Test RMSE Lassoe: {format(rmse_lasso, digits = 3)}
     Test RMSE RF: {format(rmse_rf, digits = 3)}")
```

```
## Test RMSE Ridge: 0.848
## Test RMSE Lassoe: 0.834
## Test RMSE RF: 0.648
```

---


```r
bind_rows(
  tibble(method = "Ridge", pred = pred_ridge, true = blogs_te$fb),
  tibble(method = "Lasso", pred = pred_lasso, true = blogs_te$fb),
  tibble(method = "RF", pred = pred_rf, true = blogs_te$fb)) %&gt;%
  ggplot(aes(true, pred)) +
  geom_point(color = "red", alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ factor(method, levels = c("Ridge", "Lasso", "RF"))) +
  theme_bw()
```

&lt;img src="images/Caret-Pred-vs-True-1.png" width="100%" /&gt;

---

class: section-slide

# The ~~Future~~ Present Solution: `tidymodels`

#### Inspired by [Julia Silge](https://juliasilge.com/blog/intro-tidymodels/)

---

### Packages under tidymodels

- `parsnip`: tidy `caret`
- `dials` and `tune`: specifying and tuning model parameters
- `rsample`: sampling, data partitioning
- `recipes`, `embed`, `themis`: preprocessing and creating model matrices
- `infer`: tidy statistics
- `yardstick`: measuring models performance
- `broom`: convert models output into tidy tibbles

And [more](https://www.tidymodels.org/).

.warning[
⚠️ All `tidymodels` packages are under development!
]

---

### Split Data

The `initial_split()` function is from the `rsample` package:


```r
library(tidymodels)

blogs_split_obj &lt;- blogs_fb %&gt;%
  initial_split(prop = 0.6)

print(blogs_split_obj)
```

```
## &lt;Training/Testing/Total&gt;
## &lt;31438/20959/52397&gt;
```

```r
blogs_tr &lt;- training(blogs_split_obj)
blogs_te &lt;- testing(blogs_split_obj)

glue("train no. of rows: {nrow(blogs_tr)}
     test no. of rows: {nrow(blogs_te)}")
```

```
## train no. of rows: 31438
## test no. of rows: 20959
```

---

### Preprocess .font80percent[(but we're not gonna use it)]

The `recipe()` function is from the `recipes` package. It allows you to specify a sklearn-like pipe you can later apply to any dataset, including all preprocessing steps:


```r
blogs_rec &lt;- recipe(fb ~ ., data = blogs_tr)
blogs_rec
```

```
## 
```

```
## ── Recipe ──────────────────────────────────────────────────────────────────────
```

```
## 
```

```
## ── Inputs
```

```
## Number of variables by role
```

```
## outcome:     1
## predictor: 280
```

---

The `recipes` package contains more preprocessing [`step_`s](https://tidymodels.github.io/recipes/reference/index.html) than you imagine:


```r
blogs_rec &lt;-  blogs_rec %&gt;%
  step_zv(all_numeric_predictors()) %&gt;%
  step_normalize(all_numeric_predictors())
```

---

After you have your `recipe` you need to `prep()` materials...


```r
blogs_rec &lt;- blogs_rec %&gt;% prep(blogs_tr)

blogs_rec
```

```
## 
```

```
## ── Recipe ──────────────────────────────────────────────────────────────────────
```

```
## 
```

```
## ── Inputs
```

```
## Number of variables by role
```

```
## outcome:     1
## predictor: 280
```

```
## 
```

```
## ── Training information
```

```
## Training data contained 31438 data points and no incomplete rows.
```

```
## 
```

```
## ── Operations
```

```
## • Zero variance filter removed: X13, X33, X38, X278 | Trained
```

```
## • Centering and scaling for: X1, X2, X3, X4, X5, X6, X7, X8, X9, ... | Trained
```

---

At this point our `recipe` has all necessary `sd` and `mean`s for numeric variables.


```r
blogs_rec$var_info
```

```
## # A tibble: 281 × 4
##    variable type      role      source  
##    &lt;chr&gt;    &lt;list&gt;    &lt;chr&gt;     &lt;chr&gt;   
##  1 X1       &lt;chr [2]&gt; predictor original
##  2 X2       &lt;chr [2]&gt; predictor original
##  3 X3       &lt;chr [2]&gt; predictor original
##  4 X4       &lt;chr [2]&gt; predictor original
##  5 X5       &lt;chr [2]&gt; predictor original
##  6 X6       &lt;chr [2]&gt; predictor original
##  7 X7       &lt;chr [2]&gt; predictor original
##  8 X8       &lt;chr [2]&gt; predictor original
##  9 X9       &lt;chr [2]&gt; predictor original
## 10 X10      &lt;chr [2]&gt; predictor original
## # … with 271 more rows
```

---


```r
blogs_rec$steps[[2]]$means |&gt; head()
```

```
##          X1          X2          X3          X4          X5          X6 
##  39.0127626  46.5005203   0.3999936 337.9553407  24.2832559  15.0273473
```

```r
blogs_rec$steps[[2]]$sds |&gt; head()
```

```
##        X1        X2        X3        X4        X5        X6 
##  78.02770  61.73541   8.27524 437.68953  68.58153  31.73173
```

---

And then we `bake()` (or [`juice()`](https://tidymodels.github.io/recipes/reference/juice.html)):


```r
blogs_tr2 &lt;- blogs_rec %&gt;% bake(blogs_tr)
blogs_te2 &lt;- blogs_rec %&gt;% bake(blogs_te)

glue("mean of comments in orig training: {format(mean(blogs_tr$X51), digits = 3)}, sd: {format(sd(blogs_tr$X51), digits = 3)}
     mean of comments in baked training: {format(mean(blogs_tr2$X51), digits = 1)}, sd: {format(sd(blogs_tr2$X51), digits = 3)}")
```

```
## mean of comments in orig training: 39, sd: 110
## mean of comments in baked training: 3e-17, sd: 1
```

```r
glue("mean of comments in orig testing: {format(mean(blogs_te$X51), digits = 3)}, sd: {format(sd(blogs_te$X51), digits = 3)}
     mean of comments in baked testing: {format(mean(blogs_te2$X51), digits = 1)}, sd: {format(sd(blogs_te2$X51), digits = 3)}")
```

```
## mean of comments in orig testing: 40.2, sd: 112
## mean of comments in baked testing: 0.01, sd: 1.02
```

---

Or you can do it all in a single pipe:


```r
blogs_rec &lt;- recipe(fb ~ ., data = blogs_tr) %&gt;%
  step_zv(all_numeric_predictors()) %&gt;%
  step_normalize(all_numeric_predictors()) %&gt;%
  prep(blogs_tr)

blogs_tr2 &lt;- blogs_rec %&gt;% bake(blogs_tr)
blogs_te2 &lt;- blogs_rec %&gt;% bake(blogs_te)

glue("mean of comments in orig training: {format(mean(blogs_tr$X51), digits = 3)}, sd: {format(sd(blogs_tr$X51), digits = 3)}
     mean of comments in baked training: {format(mean(blogs_tr2$X51), digits = 1)}, sd: {format(sd(blogs_tr2$X51), digits = 3)}")
```

```
## mean of comments in orig training: 39, sd: 110
## mean of comments in baked training: 3e-17, sd: 1
```

```r
glue("mean of comments in orig testing: {format(mean(blogs_te$X51), digits = 3)}, sd: {format(sd(blogs_te$X51), digits = 3)}
     mean of comments in baked testing: {format(mean(blogs_te2$X51), digits = 1)}, sd: {format(sd(blogs_te2$X51), digits = 3)}")
```

```
## mean of comments in orig testing: 40.2, sd: 112
## mean of comments in baked testing: 0.01, sd: 1.02
```

---

Can also `tidy()` a recipe:


```r
tidy(blogs_rec)
```

```
## # A tibble: 2 × 6
##   number operation type      trained skip  id             
##    &lt;int&gt; &lt;chr&gt;     &lt;chr&gt;     &lt;lgl&gt;   &lt;lgl&gt; &lt;chr&gt;          
## 1      1 step      zv        TRUE    FALSE zv_Dc9HG       
## 2      2 step      normalize TRUE    FALSE normalize_79eTz
```

---

#### Fast Forward 10 weeks from now...


```r
rec_int_topints &lt;- recipe(pets ~ ., data = okcupid_tr) %&gt;%
  step_textfeature(essays, prefix = "t",
                   extract_functions = my_text_funs) %&gt;%
  update_role(essays, new_role = "discarded") %&gt;%
  step_mutate_at(starts_with("t_"), fn = ~ifelse(is.na(.x), 0, .x)) %&gt;%
  step_log(income, starts_with("len_"), starts_with("t_"),
           -t_essays_sent_bing, offset = 1) %&gt;%
  step_meanimpute(income) %&gt;%
  step_other(
    all_nominal(), -has_role("discarded"), -all_outcomes(),
    other = "all_else", threshold = 0.1) %&gt;%
  step_novel(
    all_nominal(), -has_role("discarded"), -all_outcomes()) %&gt;%
  step_modeimpute(all_nominal(), -has_role("discarded"), -all_outcomes()) %&gt;%
  step_dummy(all_nominal(), -all_outcomes(),
             -has_role("discarded"), one_hot = FALSE) %&gt;%
  step_interact(topint_ints) %&gt;%
  step_nzv(all_numeric(), freq_cut = 99/1) %&gt;%
  step_upsample(pets, over_ratio = 1, seed = 42)
```

---

### Modeling

For now let us use the original `blogs_tr` data.

Functions `linear_reg()` and `set_engine()` are from the `parsnip` package:


```r
mod_ridge_spec &lt;- linear_reg(mixture = 0, penalty = 0.001) %&gt;%
  set_engine(engine = "glmnet")

mod_ridge_spec
```

```
## Linear Regression Model Specification (regression)
## 
## Main Arguments:
##   penalty = 0.001
##   mixture = 0
## 
## Computational engine: glmnet
```

---


```r
mod_ridge &lt;- mod_ridge_spec %&gt;%
  fit(fb ~ ., data = blogs_tr)

mod_ridge
```

```
## parsnip model object
## 
## 
## Call:  glmnet::glmnet(x = maybe_matrix(x), y = y, family = "gaussian",      alpha = ~0) 
## 
##      Df  %Dev Lambda
## 1   276  0.00 600.50
## 2   276  2.57 547.10
## 3   276  2.80 498.50
## 4   276  3.05 454.30
## 5   276  3.32 413.90
## 6   276  3.61 377.10
## 7   276  3.92 343.60
## 8   276  4.25 313.10
## 9   276  4.61 285.30
## 10  276  4.99 259.90
## 11  276  5.40 236.80
## 12  276  5.84 215.80
## 13  276  6.30 196.60
## 14  276  6.79 179.20
## 15  276  7.30 163.20
## 16  276  7.85 148.70
## 17  276  8.42 135.50
## 18  276  9.02 123.50
## 19  276  9.64 112.50
## 20  276 10.29 102.50
## 21  276 10.96  93.42
## 22  276 11.65  85.12
## 23  276 12.36  77.56
## 24  276 13.09  70.67
## 25  276 13.83  64.39
## 26  276 14.59  58.67
## 27  276 15.35  53.46
## 28  276 16.12  48.71
## 29  276 16.89  44.38
## 30  276 17.66  40.44
## 31  276 18.43  36.85
## 32  276 19.19  33.57
## 33  276 19.95  30.59
## 34  276 20.70  27.87
## 35  276 21.44  25.40
## 36  276 22.16  23.14
## 37  276 22.88  21.08
## 38  276 23.58  19.21
## 39  276 24.27  17.50
## 40  276 24.94  15.95
## 41  276 25.61  14.53
## 42  276 26.26  13.24
## 43  276 26.90  12.07
## 44  276 27.53  10.99
## 45  276 28.15  10.02
## 46  276 28.76   9.13
## 47  276 29.36   8.32
## 48  276 29.95   7.58
## 49  276 30.54   6.90
## 50  276 31.11   6.29
## 51  276 31.68   5.73
## 52  276 32.24   5.22
## 53  276 32.79   4.76
## 54  276 33.34   4.34
## 55  276 33.87   3.95
## 56  276 34.40   3.60
## 57  276 34.91   3.28
## 58  276 35.41   2.99
## 59  276 35.90   2.72
## 60  276 36.38   2.48
## 61  276 36.84   2.26
## 62  276 37.29   2.06
## 63  276 37.72   1.88
## 64  276 38.14   1.71
## 65  276 38.54   1.56
## 66  276 38.93   1.42
## 67  276 39.29   1.29
## 68  276 39.64   1.18
## 69  276 39.97   1.07
## 70  276 40.29   0.98
## 71  276 40.59   0.89
## 72  276 40.87   0.81
## 73  276 41.13   0.74
## 74  276 41.38   0.67
## 75  276 41.62   0.61
## 76  276 41.84   0.56
## 77  276 42.05   0.51
## 78  276 42.24   0.46
## 79  276 42.43   0.42
## 80  276 42.60   0.39
## 81  276 42.76   0.35
## 82  276 42.92   0.32
## 83  276 43.07   0.29
## 84  276 43.22   0.27
## 85  276 43.35   0.24
## 86  276 43.49   0.22
## 87  276 43.61   0.20
## 88  276 43.74   0.18
## 89  276 43.86   0.17
## 90  276 43.98   0.15
## 91  276 44.10   0.14
## 92  276 44.21   0.13
## 93  276 44.32   0.12
## 94  276 44.43   0.10
## 95  276 44.54   0.10
## 96  276 44.64   0.09
## 97  276 44.74   0.08
## 98  276 44.84   0.07
## 99  276 44.94   0.07
## 100 276 45.04   0.06
```

---

In a single pipe:


```r
mod_lasso &lt;- linear_reg(mixture = 1, penalty = 0.001) %&gt;%
  set_engine(engine = "glmnet") %&gt;%
  fit(fb ~ ., data = blogs_tr)

mod_lasso
```

```
## parsnip model object
## 
## 
## Call:  glmnet::glmnet(x = maybe_matrix(x), y = y, family = "gaussian",      alpha = ~1) 
## 
##     Df  %Dev  Lambda
## 1    0  0.00 0.60050
## 2    1  4.79 0.54710
## 3    1  8.76 0.49850
## 4    3 12.97 0.45430
## 5    3 16.73 0.41390
## 6    3 19.85 0.37710
## 7    3 22.45 0.34360
## 8    3 24.60 0.31310
## 9    4 26.54 0.28530
## 10   4 28.94 0.25990
## 11   4 30.94 0.23680
## 12   4 32.59 0.21580
## 13   4 33.97 0.19660
## 14   4 35.11 0.17920
## 15   4 36.05 0.16320
## 16   4 36.84 0.14870
## 17   4 37.49 0.13550
## 18   4 38.03 0.12350
## 19   4 38.48 0.11250
## 20   5 38.86 0.10250
## 21   5 39.17 0.09342
## 22   6 39.48 0.08512
## 23   7 39.79 0.07756
## 24   6 40.05 0.07067
## 25   7 40.29 0.06439
## 26   8 40.52 0.05867
## 27   8 40.72 0.05346
## 28   9 40.89 0.04871
## 29  11 41.05 0.04438
## 30  13 41.21 0.04044
## 31  14 41.36 0.03685
## 32  15 41.50 0.03357
## 33  18 41.62 0.03059
## 34  22 41.73 0.02787
## 35  23 41.84 0.02540
## 36  26 41.93 0.02314
## 37  28 42.02 0.02108
## 38  29 42.10 0.01921
## 39  38 42.23 0.01750
## 40  42 42.41 0.01595
## 41  60 42.57 0.01453
## 42  64 42.77 0.01324
## 43  74 42.96 0.01207
## 44  68 43.17 0.01099
## 45  79 43.34 0.01002
## 46  92 43.53 0.00913
## 47  98 43.76 0.00832
## 48 108 43.97 0.00758
## 49 118 44.16 0.00690
## 50 123 44.38 0.00629
## 51 124 44.58 0.00573
## 52 131 44.73 0.00522
## 53 138 44.90 0.00476
## 54 152 45.10 0.00434
## 55 151 45.33 0.00395
## 56 156 45.53 0.00360
## 57 161 45.69 0.00328
## 58 165 45.84 0.00299
## 59 171 45.98 0.00272
## 60 180 46.09 0.00248
## 61 177 46.19 0.00226
## 62 176 46.27 0.00206
## 63 177 46.34 0.00188
## 64 189 46.40 0.00171
## 65 194 46.44 0.00156
## 66 209 46.50 0.00142
## 67 208 46.57 0.00129
## 68 212 46.62 0.00118
## 69 217 46.66 0.00107
## 70 219 46.70 0.00098
## 71 221 46.73 0.00089
## 72 222 46.77 0.00081
## 73 225 46.79 0.00074
## 74 228 46.83 0.00067
## 75 233 46.86 0.00061
## 76 231 46.92 0.00056
## 77 237 46.97 0.00051
## 78 237 47.02 0.00046
## 79 238 47.05 0.00042
## 80 236 47.08 0.00039
## 81 236 47.11 0.00035
## 82 235 47.14 0.00032
## 83 236 47.16 0.00029
## 84 237 47.17 0.00027
## 85 237 47.18 0.00024
## 86 236 47.20 0.00022
## 87 237 47.21 0.00020
## 88 239 47.22 0.00018
## 89 237 47.23 0.00017
## 90 238 47.24 0.00015
## 91 238 47.25 0.00014
## 92 241 47.26 0.00013
## 93 241 47.27 0.00012
## 94 241 47.28 0.00010
## 95 243 47.29 0.00010
## 96 251 47.29 0.00009
## 97 245 47.29 0.00008
## 98 249 47.29 0.00007
## 99 254 47.29 0.00007
```

---

Can also use `fit_xy()` a-la `sklearn`:


```r
mod_rf &lt;- rand_forest(mode = "regression", mtry = 50, trees = 50, min_n = 10) %&gt;%
  set_engine("ranger") %&gt;%
  fit_xy(x = blogs_tr[, -281],
         y = blogs_tr$fb)

mod_rf
```

```
## parsnip model object
## 
## Ranger result
## 
## Call:
##  ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~50,      x), num.trees = ~50, min.node.size = min_rows(~10, x), num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1)) 
## 
## Type:                             Regression 
## Number of trees:                  50 
## Sample size:                      31438 
## Number of independent variables:  280 
## Mtry:                             50 
## Target node size:                 10 
## Variable importance mode:         none 
## Splitrule:                        variance 
## OOB prediction error (MSE):       0.4304248 
## R squared (OOB):                  0.6633549
```

---

Notice how easy it is to get the model's results in a tidy way using the `tidy()` function:


```r
tidy(mod_ridge)
```

```
## # A tibble: 281 × 3
##    term         estimate penalty
##    &lt;chr&gt;           &lt;dbl&gt;   &lt;dbl&gt;
##  1 (Intercept)  0.684      0.001
##  2 X1           0.00129    0.001
##  3 X2           0.00131    0.001
##  4 X3          -0.00149    0.001
##  5 X4           0.000321   0.001
##  6 X5           0.000212   0.001
##  7 X6           0.00217    0.001
##  8 X7          -0.00128    0.001
##  9 X8           0.115      0.001
## 10 X9          -0.000138   0.001
## # … with 271 more rows
```

---

### Predicting


```r
results_test &lt;- mod_ridge %&gt;%
  predict(new_data = blogs_te, penalty = 0.001) %&gt;%
  mutate(
    truth = blogs_te$fb,
    method = "Ridge"
  ) %&gt;%
  bind_rows(mod_lasso %&gt;%
    predict(new_data = blogs_te) %&gt;%
    mutate(
      truth = blogs_te$fb,
      method = "Lasso"
  )) %&gt;%
  bind_rows(mod_rf %&gt;%
    predict(new_data = blogs_te) %&gt;%
    mutate(
      truth = blogs_te$fb,
      method = "RF"
  ))

dim(results_test)
```

```
## [1] 62877     3
```

```r
head(results_test)
```

```
## # A tibble: 6 × 3
##   .pred truth method
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt; 
## 1 0.900 0.693 Ridge 
## 2 0.205 0     Ridge 
## 3 0.205 0     Ridge 
## 4 0.520 2.30  Ridge 
## 5 1.00  0     Ridge 
## 6 0.359 0     Ridge
```

---

### Comparing Models

The package `yardstick` has tons of performance [metrics](https://tidymodels.github.io/yardstick/articles/metric-types.html):


```r
results_test %&gt;%
  group_by(method) %&gt;%
  rmse(truth = truth, estimate = .pred)
```

```
## # A tibble: 3 × 4
##   method .metric .estimator .estimate
##   &lt;chr&gt;  &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 Lasso  rmse    standard       0.834
## 2 RF     rmse    standard       0.643
## 3 Ridge  rmse    standard       0.845
```

---


```r
results_test %&gt;%
  ggplot(aes(truth, .pred)) +
  geom_point(color = "red", alpha = 0.5) +
  geom_abline(slope = 1, intercept = 0) +
  facet_wrap(~ factor(method, levels = c("Ridge", "Lasso", "RF"))) +
  theme_bw()
```

&lt;img src="images/Tidymodels-Pred-vs-True-1.png" width="100%" /&gt;

---

### Tuning

Define your model spec, using `tune()` from the `tune` package for a parameter you wish to tune:


```r
mod_rf_spec &lt;- rand_forest(mode = "regression",
                           mtry = tune(),
                           min_n = tune(),
                           trees = 100) %&gt;%
  set_engine("ranger")
```

---

Define the `grid` on which you train your params, with the `dials` package:


```r
rf_grid &lt;- grid_regular(mtry(range(10, 70)), min_n(range(10, 30)),
                        levels = c(4, 3))

rf_grid
```

```
## # A tibble: 12 × 2
##     mtry min_n
##    &lt;int&gt; &lt;int&gt;
##  1    10    10
##  2    30    10
##  3    50    10
##  4    70    10
##  5    10    20
##  6    30    20
##  7    50    20
##  8    70    20
##  9    10    30
## 10    30    30
## 11    50    30
## 12    70    30
```

---

Split your data into a few folds for Cross Validation with `vfold_cv()` from the `rsample` package:


```r
cv_splits &lt;- vfold_cv(blogs_tr, v = 5)

cv_splits
```

```
## #  5-fold cross-validation 
## # A tibble: 5 × 2
##   splits               id   
##   &lt;list&gt;               &lt;chr&gt;
## 1 &lt;split [25150/6288]&gt; Fold1
## 2 &lt;split [25150/6288]&gt; Fold2
## 3 &lt;split [25150/6288]&gt; Fold3
## 4 &lt;split [25151/6287]&gt; Fold4
## 5 &lt;split [25151/6287]&gt; Fold5
```

---

Now perform cross validation with `tune_grid()` from the `tune` package:


```r
tune_res &lt;- tune_grid(mod_rf_spec,
                      recipe(fb ~ ., data = blogs_tr),
                      resamples = cv_splits,
                      grid = rf_grid,
                      metrics = metric_set(rmse))
tune_res
```


```
## # Tuning results
## # 5-fold cross-validation 
## # A tibble: 5 × 4
##   splits               id    .metrics          .notes          
##   &lt;list&gt;               &lt;chr&gt; &lt;list&gt;            &lt;list&gt;          
## 1 &lt;split [25150/6288]&gt; Fold1 &lt;tibble [12 × 6]&gt; &lt;tibble [0 × 1]&gt;
## 2 &lt;split [25150/6288]&gt; Fold2 &lt;tibble [12 × 6]&gt; &lt;tibble [0 × 1]&gt;
## 3 &lt;split [25150/6288]&gt; Fold3 &lt;tibble [12 × 6]&gt; &lt;tibble [0 × 1]&gt;
## 4 &lt;split [25151/6287]&gt; Fold4 &lt;tibble [12 × 6]&gt; &lt;tibble [0 × 1]&gt;
## 5 &lt;split [25151/6287]&gt; Fold5 &lt;tibble [12 × 6]&gt; &lt;tibble [0 × 1]&gt;
```

---


```r
tune_res$.metrics[[1]]
```

```
## # A tibble: 12 × 6
##     mtry min_n .metric .estimator .estimate .config              
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt; &lt;chr&gt;                
##  1    10    10 rmse    standard       0.687 Preprocessor1_Model01
##  2    30    10 rmse    standard       0.649 Preprocessor1_Model02
##  3    50    10 rmse    standard       0.644 Preprocessor1_Model03
##  4    70    10 rmse    standard       0.642 Preprocessor1_Model04
##  5    10    20 rmse    standard       0.697 Preprocessor1_Model05
##  6    30    20 rmse    standard       0.655 Preprocessor1_Model06
##  7    50    20 rmse    standard       0.646 Preprocessor1_Model07
##  8    70    20 rmse    standard       0.643 Preprocessor1_Model08
##  9    10    30 rmse    standard       0.701 Preprocessor1_Model09
## 10    30    30 rmse    standard       0.657 Preprocessor1_Model10
## 11    50    30 rmse    standard       0.651 Preprocessor1_Model11
## 12    70    30 rmse    standard       0.643 Preprocessor1_Model12
```

---

Collect the mean metric across folds:


```r
estimates &lt;- collect_metrics(tune_res)

estimates
```

```
## # A tibble: 12 × 8
##     mtry min_n .metric .estimator  mean     n std_err .config              
##    &lt;int&gt; &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;                
##  1    10    10 rmse    standard   0.698     5 0.00647 Preprocessor1_Model01
##  2    30    10 rmse    standard   0.656     5 0.00673 Preprocessor1_Model02
##  3    50    10 rmse    standard   0.648     5 0.00569 Preprocessor1_Model03
##  4    70    10 rmse    standard   0.646     5 0.00572 Preprocessor1_Model04
##  5    10    20 rmse    standard   0.704     5 0.00668 Preprocessor1_Model05
##  6    30    20 rmse    standard   0.662     5 0.00638 Preprocessor1_Model06
##  7    50    20 rmse    standard   0.650     5 0.00527 Preprocessor1_Model07
##  8    70    20 rmse    standard   0.647     5 0.00576 Preprocessor1_Model08
##  9    10    30 rmse    standard   0.710     5 0.00740 Preprocessor1_Model09
## 10    30    30 rmse    standard   0.664     5 0.00590 Preprocessor1_Model10
## 11    50    30 rmse    standard   0.654     5 0.00526 Preprocessor1_Model11
## 12    70    30 rmse    standard   0.649     5 0.00567 Preprocessor1_Model12
```

---

Choose best parameter:


```r
estimates %&gt;%
  mutate(min_n = factor(min_n)) %&gt;%
  ggplot(aes(x = mtry, y = mean, color = min_n)) + 
  geom_point() + 
  geom_line() + 
  labs(y = "Mean RMSE") +
  theme_bw()
```

&lt;img src="images/Tidymodels-RMSE-Comp-1.png" width="100%" /&gt;

---

There are of course also methods for helping us choose best params and final model.


```r
best_rmse &lt;- tune_res %&gt;% select_best(metric = "rmse")
best_rmse
```

```
## # A tibble: 1 × 3
##    mtry min_n .config              
##   &lt;int&gt; &lt;int&gt; &lt;chr&gt;                
## 1    70    10 Preprocessor1_Model04
```

See also `?select_by_one_std_err`.


```r
mod_rf_final &lt;- finalize_model(mod_rf_spec, best_rmse)
mod_rf_final
```

```
## Random Forest Model Specification (regression)
## 
## Main Arguments:
##   mtry = 70
##   trees = 100
##   min_n = 10
## 
## Computational engine: ranger
```

---


```r
mod_rf_final %&gt;%
  fit(fb ~ ., data = blogs_tr) %&gt;%
  predict(new_data = blogs_te) %&gt;%
  mutate(truth = blogs_te$fb) %&gt;%
  head(10)
```


```
## # A tibble: 10 × 2
##    .pred truth
##    &lt;dbl&gt; &lt;dbl&gt;
##  1 0.584 0.693
##  2 0.584 0.693
##  3 0.238 0    
##  4 1.79  2.30 
##  5 1.79  2.30 
##  6 0.145 0    
##  7 3.33  1.10 
##  8 0.719 1.39 
##  9 2.40  3.09 
## 10 1.14  0.693
```

---

### Workflow

As we shall see, this manual approach won't scale, is prone to bugs and will not play nicely with other modeling components:


```r
results_test &lt;- mod_ridge %&gt;%
  predict(new_data = blogs_te, penalty = 0.001) %&gt;%
  mutate(
    truth = blogs_te$fb,
    method = "Ridge"
  ) %&gt;%
  bind_rows(mod_lasso %&gt;%
    predict(new_data = blogs_te) %&gt;%
    mutate(
      truth = blogs_te$fb,
      method = "Lasso"
  )) %&gt;%
  bind_rows(mod_rf %&gt;%
    predict(new_data = blogs_te) %&gt;%
    mutate(
      truth = blogs_te$fb,
      method = "RF"
  ))
```

---

Similar to sklearn's `Pipeline()` class, we need a `workflow()`: to bundle together your pre-processing, modeling, and post-processing requests.


```r
mod_rf &lt;- rand_forest(mode = "regression", mtry = 70, trees = 100, min_n = 10) %&gt;%
  set_engine("ranger")

blogs_rec &lt;- recipe(fb ~ ., data = blogs_tr) %&gt;%
  step_zv(all_numeric_predictors()) %&gt;%
  step_normalize(all_numeric_predictors())

wflow_rf &lt;-
  workflow() %&gt;%
  add_recipe(blogs_rec) %&gt;%
  add_model(mod_rf)
```

---


```r
wflow_rf
```

```
## ══ Workflow ════════════════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## • step_zv()
## • step_normalize()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Random Forest Model Specification (regression)
## 
## Main Arguments:
##   mtry = 70
##   trees = 100
##   min_n = 10
## 
## Computational engine: ranger
```

---

Calling `fit()` will `prep()` the recipe **and** `fit()` the model:




```r
fit_rf &lt;- fit(wflow_rf, blogs_tr)
```

It is still a `workflow()` object:


```r
fit_rf
```

```
## ══ Workflow [trained] ══════════════════════════════════════════════════════════
## Preprocessor: Recipe
## Model: rand_forest()
## 
## ── Preprocessor ────────────────────────────────────────────────────────────────
## 2 Recipe Steps
## 
## • step_zv()
## • step_normalize()
## 
## ── Model ───────────────────────────────────────────────────────────────────────
## Ranger result
## 
## Call:
##  ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~70,      x), num.trees = ~100, min.node.size = min_rows(~10, x), num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1)) 
## 
## Type:                             Regression 
## Number of trees:                  100 
## Sample size:                      31438 
## Number of independent variables:  276 
## Mtry:                             70 
## Target node size:                 10 
## Variable importance mode:         none 
## Splitrule:                        variance 
## OOB prediction error (MSE):       0.4176772 
## R squared (OOB):                  0.677417
```

---

Can extract the prepped recipe:


```r
fit_rf %&gt;%
  extract_recipe()
```

```
## 
```

```
## ── Recipe ──────────────────────────────────────────────────────────────────────
```

```
## 
```

```
## ── Inputs
```

```
## Number of variables by role
```

```
## outcome:     1
## predictor: 280
```

```
## 
```

```
## ── Training information
```

```
## Training data contained 31438 data points and no incomplete rows.
```

```
## 
```

```
## ── Operations
```

```
## • Zero variance filter removed: X13, X33, X38, X278 | Trained
```

```
## • Centering and scaling for: X1, X2, X3, X4, X5, X6, X7, X8, X9, ... | Trained
```

---

Can extract the actual parsnip model:


```r
fit_rf %&gt;%
  extract_fit_parsnip()
```

```
## parsnip model object
## 
## Ranger result
## 
## Call:
##  ranger::ranger(x = maybe_data_frame(x), y = y, mtry = min_cols(~70,      x), num.trees = ~100, min.node.size = min_rows(~10, x), num.threads = 1,      verbose = FALSE, seed = sample.int(10^5, 1)) 
## 
## Type:                             Regression 
## Number of trees:                  100 
## Sample size:                      31438 
## Number of independent variables:  276 
## Mtry:                             70 
## Target node size:                 10 
## Variable importance mode:         none 
## Splitrule:                        variance 
## OOB prediction error (MSE):       0.4176772 
## R squared (OOB):                  0.677417
```

---

Calling `predict()` with a new dataset will `bake()` the new dataset using the prepped recipe, and `predict()` the trained model:


```r
res_rf &lt;- predict(fit_rf, blogs_te)

res_rf %&gt;% head(10)
```

```
## # A tibble: 10 × 1
##     .pred
##     &lt;dbl&gt;
##  1 0.477 
##  2 0.0928
##  3 0.0928
##  4 2.16  
##  5 0.150 
##  6 0.163 
##  7 2.48  
##  8 2.48  
##  9 2.68  
## 10 2.68
```

---

Calling `fit_resamples()` or `tune_grid()` works with a `vfold_cv()` splits object:


```
## # Resampling results
## # 5-fold cross-validation 
## # A tibble: 5 × 4
##   splits               id    .metrics         .notes          
##   &lt;list&gt;               &lt;chr&gt; &lt;list&gt;           &lt;list&gt;          
## 1 &lt;split [25150/6288]&gt; Fold1 &lt;tibble [1 × 4]&gt; &lt;tibble [0 × 3]&gt;
## 2 &lt;split [25150/6288]&gt; Fold2 &lt;tibble [1 × 4]&gt; &lt;tibble [0 × 3]&gt;
## 3 &lt;split [25150/6288]&gt; Fold3 &lt;tibble [1 × 4]&gt; &lt;tibble [0 × 3]&gt;
## 4 &lt;split [25151/6287]&gt; Fold4 &lt;tibble [1 × 4]&gt; &lt;tibble [0 × 3]&gt;
## 5 &lt;split [25151/6287]&gt; Fold5 &lt;tibble [1 × 4]&gt; &lt;tibble [0 × 3]&gt;
```


```r
cv_splits &lt;- vfold_cv(blogs_tr, v = 5)

fit_rf_cv &lt;- fit_resamples(wflow_rf, cv_splits, metrics = metric_set(rmse))

fit_rf_cv
```

Can use `collect_metrics()` etc.

---

But the real advantage of working with `workflow()`s is when comparing different recipes `\(\times\)` different models, via `workflow_set()`:


```r
mod_ridge &lt;- linear_reg(mixture = 0, penalty = 0.001) %&gt;%
  set_engine(engine = "glmnet")

mod_lasso &lt;- linear_reg(mixture = 1, penalty = 0.001) %&gt;%
  set_engine(engine = "glmnet")

mod_list &lt;- list(RF = mod_rf, Ridge = mod_ridge, Lasso = mod_lasso)

rec_list &lt;- list(basic = blogs_rec) # can add more..

wset &lt;- workflow_set(rec_list, mod_list) # checkout the cross arg

wset
```

```
## # A workflow set/tibble: 3 × 4
##   wflow_id    info             option    result    
##   &lt;chr&gt;       &lt;list&gt;           &lt;list&gt;    &lt;list&gt;    
## 1 basic_RF    &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
## 2 basic_Ridge &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
## 3 basic_Lasso &lt;tibble [1 × 4]&gt; &lt;opts[0]&gt; &lt;list [0]&gt;
```

---

Now use a `purrr`-like mapping function to fit all on all resamples:


```r
wset &lt;-
  wset %&gt;%
  workflow_map("fit_resamples", resamples = cv_splits)
```


```
## # A workflow set/tibble: 3 × 4
##   wflow_id    info             option    result   
##   &lt;chr&gt;       &lt;list&gt;           &lt;list&gt;    &lt;list&gt;   
## 1 basic_RF    &lt;tibble [1 × 4]&gt; &lt;opts[1]&gt; &lt;rsmp[+]&gt;
## 2 basic_Ridge &lt;tibble [1 × 4]&gt; &lt;opts[1]&gt; &lt;rsmp[+]&gt;
## 3 basic_Lasso &lt;tibble [1 × 4]&gt; &lt;opts[1]&gt; &lt;rsmp[+]&gt;
```

And use e.g. `collect_metrics()` to select the best recipe/model combination.

---

### Book (WIP?)

&lt;img src="images/tmwr.png" style="width: 45%" /&gt;

https://www.tmwr.org/

---

class: section-slide

# `infer`: Tidy Statistics

---

### Statistical Q1

Is there a relation between posts published on Sundays and blogger hand dominance, where hand dominance is totally made up? 😬




```r
pub_vs_hand &lt;- blogs_fb %&gt;%
  select(sunday, hand) %&gt;%
  table()

pub_vs_hand
```

```
##       hand
## sunday  left right
##     NS  4788 42950
##     S    436  4223
```


```r
prop.table(pub_vs_hand, margin = 1)
```

```
##       hand
## sunday       left      right
##     NS 0.10029746 0.89970254
##     S  0.09358231 0.90641769
```

---

### Statistical Q2

Is there a difference in feedback between posts published on Sundays and posts published on another day?


```r
blogs_fb %&gt;%
  group_by(sunday) %&gt;% summarise(avg = mean(fb), sd = sd(fb), n = n())
```

```
## # A tibble: 2 × 4
##   sunday   avg    sd     n
##   &lt;fct&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt;
## 1 NS     0.645  1.13 47738
## 2 S      0.605  1.12  4659
```

---

### Same Problem!

Varied interface, varied output.


```r
prop.test(pub_vs_hand[,1], rowSums(pub_vs_hand))
```

```
## 
## 	2-sample test for equality of proportions with continuity correction
## 
## data:  pub_vs_hand[, 1] out of rowSums(pub_vs_hand)
## X-squared = 2.0583, df = 1, p-value = 0.1514
## alternative hypothesis: two.sided
## 95 percent confidence interval:
##  -0.002189083  0.015619369
## sample estimates:
##     prop 1     prop 2 
## 0.10029746 0.09358231
```

---


```r
t.test(fb ~ sunday, data = blogs_fb)
```

```
## 
## 	Welch Two Sample t-test
## 
## data:  fb by sunday
## t = 2.3606, df = 5638.9, p-value = 0.01828
## alternative hypothesis: true difference in means between group NS and group S is not equal to 0
## 95 percent confidence interval:
##  0.006863705 0.074103874
## sample estimates:
## mean in group NS  mean in group S 
##        0.6454439        0.6049601
```

---

### The `generics::tidy()` Approach

(Also available when you load several other packages, like `broom` and `yardstick`)


```r
tidy(prop.test(pub_vs_hand[,1], rowSums(pub_vs_hand)))
```

```
## # A tibble: 1 × 9
##   estimate1 estimate2 statistic p.value parameter conf.low conf.high method     
##       &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt; &lt;chr&gt;      
## 1     0.100    0.0936      2.06   0.151         1 -0.00219    0.0156 2-sample t…
## # … with 1 more variable: alternative &lt;chr&gt;
```


```r
tidy(t.test(fb ~ sunday, data = blogs_fb))
```

```
## # A tibble: 1 × 10
##   estimate estimate1 estimate2 statistic p.value parameter conf.low conf.high
##      &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;   &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;     &lt;dbl&gt;
## 1   0.0405     0.645     0.605      2.36  0.0183     5639.  0.00686    0.0741
## # … with 2 more variables: method &lt;chr&gt;, alternative &lt;chr&gt;
```

---

### The `infer` Approach

&gt; infer implements an expressive grammar to perform statistical inference that coheres with the tidyverse design framework

4 main verbs for a typical flow:

* `specify()` - dependent/independent variables, formula
* `hypothesize()` - declare the null hypothesis
* `generate()` - generate data reflecting the null hypothesis (the permutation/bootstrap approach)
* `calculate()` - calculate a distribution of statistics from the generated data, from which you can extract conclusion based on a p-value for example

---

### `infer` Diff in Proportions Test

Get the observed statistic (here manually in order to not confuse you, there *is* a way via `infer`):


```r
pub_vs_hand
```

```
##       hand
## sunday  left right
##     NS  4788 42950
##     S    436  4223
```


```r
p_NS &lt;- pub_vs_hand[1, 1] / (sum(pub_vs_hand[1, ]))
p_S &lt;- pub_vs_hand[2, 1] / (sum(pub_vs_hand[2, ]))
obs_diff &lt;- p_NS - p_S
obs_diff
```

```
## [1] 0.006715143
```

---

Get distribution of the difference in proportions under null hypothesis


```r
diff_null_perm &lt;- blogs_fb %&gt;%
  specify(hand ~ sunday, success = "left") %&gt;%
  hypothesize(null = "independence") %&gt;%
  generate(reps = 200, type = "permute") %&gt;%
  calculate(stat = "diff in props", order = c("NS", "S"))

diff_null_perm
```

```
## Response: hand (factor)
## Explanatory: sunday (factor)
## Null Hypothesis: independence
## # A tibble: 200 × 2
##    replicate      stat
##        &lt;int&gt;     &lt;dbl&gt;
##  1         1 -0.000588
##  2         2 -0.00153 
##  3         3  0.00884 
##  4         4  0.00365 
##  5         5 -0.00129 
##  6         6 -0.00177 
##  7         7  0.00106 
##  8         8  0.00106 
##  9         9 -0.00247 
## 10        10 -0.000352
## # … with 190 more rows
```

---

Visualize the permuted difference null distribution and the p-value


```r
visualize(diff_null_perm) +
  shade_p_value(obs_stat = obs_diff, direction = "two_sided")
```

&lt;img src="images/Diff-in-Props-Null-1.png" width="50%" /&gt;

---

Get the actual p-value:


```r
diff_null_perm %&gt;% 
  get_p_value(obs_stat = obs_diff, direction = "two_sided")
```

```
## # A tibble: 1 × 1
##   p_value
##     &lt;dbl&gt;
## 1    0.14
```

---

### `infer` t Test (independent samples)

Get the observed statistic (here via `infer`):


```r
obs_t &lt;- blogs_fb %&gt;%
  specify(fb ~ sunday) %&gt;%
  calculate(stat = "t", order = c("NS", "S"))
obs_t
```

```
## Response: fb (numeric)
## Explanatory: sunday (factor)
## # A tibble: 1 × 1
##    stat
##   &lt;dbl&gt;
## 1  2.36
```


---

Get distribution of the t statistic under null hypothesis


```r
t_null_perm &lt;- blogs_fb %&gt;%
  specify(fb ~ sunday) %&gt;%
  hypothesize(null = "independence") %&gt;%
  generate(reps = 100, type = "permute") %&gt;%
  calculate(stat = "t", order = c("NS", "S"))

t_null_perm
```

```
## Response: fb (numeric)
## Explanatory: sunday (factor)
## Null Hypothesis: independence
## # A tibble: 100 × 2
##    replicate     stat
##        &lt;int&gt;    &lt;dbl&gt;
##  1         1 -2.04   
##  2         2  0.961  
##  3         3  0.782  
##  4         4  0.00496
##  5         5 -1.30   
##  6         6 -0.635  
##  7         7 -0.634  
##  8         8  0.913  
##  9         9 -1.04   
## 10        10  1.16   
## # … with 90 more rows
```

---

Visualize the permuted t statistic null distribution and the two-sided p-value


```r
visualize(t_null_perm) +
  shade_p_value(obs_stat = obs_t, direction = "two_sided")
```

&lt;img src="images/T-Null-1.png" width="50%" /&gt;

---

Get the actual p-value:


```r
t_null_perm %&gt;% 
  get_p_value(obs_stat = obs_t, direction = "two_sided")
```

```
## # A tibble: 1 × 1
##   p_value
##     &lt;dbl&gt;
## 1    0.08
```
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="../libs/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
// add `data-at-shortcutkeys` attribute to <body> to resolve conflicts with JAWS
// screen reader (see PR #262)
(function(d) {
  let res = {};
  d.querySelectorAll('.remark-help-content table tr').forEach(tr => {
    const t = tr.querySelector('td:nth-child(2)').innerText;
    tr.querySelectorAll('td:first-child .key').forEach(key => {
      const k = key.innerText;
      if (/^[a-z]$/.test(k)) res[k] = t;  // must be a single letter (key)
    });
  });
  d.body.setAttribute('data-at-shortcutkeys', JSON.stringify(res));
})(document);
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
